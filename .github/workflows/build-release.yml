name: Build and Release

on:
  push:
    tags:
      - 'v*'  # è§¦å‘æ¡ä»¶ï¼šæŽ¨é€ v* æ ‡ç­¾ï¼ˆå¦‚ v1.0.0ï¼‰
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  build-macos:
    name: Build macOS
    runs-on: macos-latest
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
      
      - name: è®¾ç½® Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.9'
      
      - name: å®‰è£…ä¾èµ–
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pyinstaller
      
      - name: æ‰“åŒ…åº”ç”¨
        run: |
          pyinstaller WeiboLifeboat.spec --clean --noconfirm
      
      - name: åˆ›å»º DMG
        run: |
          # èŽ·å–ç‰ˆæœ¬å·ï¼ˆä»Ž tag æˆ–ä½¿ç”¨é»˜è®¤å€¼ï¼‰
          if [ -n "${{ github.ref_name }}" ]; then
            VERSION="${{ github.ref_name }}"
            VERSION="${VERSION#v}"  # ç§»é™¤ v å‰ç¼€
          else
            VERSION="1.0.0"
          fi
          
          echo "æ­£åœ¨åˆ›å»º DMGï¼Œç‰ˆæœ¬ï¼š${VERSION}"
          
          # åˆ›å»º DMG
          hdiutil create -volname "å¾®åšé€ƒç”Ÿèˆ±" \
            -srcfolder dist/WeiboLifeboat.app \
            -ov -format UDZO \
            "dist/å¾®åšé€ƒç”Ÿèˆ±-${VERSION}-macOS.dmg"
          
          # æ˜¾ç¤ºæ–‡ä»¶å¤§å°
          ls -lh dist/*.dmg
      
      - name: ä¸Šä¼  DMG
        uses: actions/upload-artifact@v4
        with:
          name: macos-dmg
          path: dist/*.dmg
          retention-days: 7

  build-windows:
    name: Build Windows
    runs-on: windows-latest
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
      
      - name: è®¾ç½® Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.9'
      
      - name: å®‰è£…ä¾èµ–
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pyinstaller
      
      - name: æ‰“åŒ…åº”ç”¨
        run: |
          pyinstaller WeiboLifeboat.spec --clean --noconfirm
      
      - name: åˆ›å»º ZIP
        shell: pwsh
        run: |
          # èŽ·å–ç‰ˆæœ¬å·
          $VERSION = "${{ github.ref_name }}"
          if ($VERSION) {
            $VERSION = $VERSION -replace '^v', ''
          } else {
            $VERSION = "1.0.0"
          }
          
          Write-Host "æ­£åœ¨åˆ›å»º ZIPï¼Œç‰ˆæœ¬ï¼š$VERSION"
          
          # åŽ‹ç¼©
          Compress-Archive -Path dist\WeiboLifeboat -DestinationPath "dist\å¾®åšé€ƒç”Ÿèˆ±-$VERSION-Windows.zip"
          
          # æ˜¾ç¤ºæ–‡ä»¶å¤§å°
          Get-ChildItem dist\*.zip | Format-Table Name, Length
      
      - name: ä¸Šä¼  ZIP
        uses: actions/upload-artifact@v4
        with:
          name: windows-zip
          path: dist/*.zip
          retention-days: 7

  release:
    name: Create Release
    needs: [build-macos, build-windows]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')  # åªåœ¨æŽ¨é€ tag æ—¶åˆ›å»º release
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
      
      - name: ä¸‹è½½ macOS DMG
        uses: actions/download-artifact@v4
        with:
          name: macos-dmg
          path: artifacts/
      
      - name: ä¸‹è½½ Windows ZIP
        uses: actions/download-artifact@v4
        with:
          name: windows-zip
          path: artifacts/
      
      - name: ç”Ÿæˆ Release Notes
        id: release_notes
        run: |
          VERSION="${{ github.ref_name }}"
          VERSION="${VERSION#v}"
          
          cat > release_notes.md << 'EOF'
          # å¾®åšé€ƒç”Ÿèˆ± / Weibo Lifeboat v${VERSION}
          
          ## ðŸ“¦ ä¸‹è½½ / Download
          
          ### macOS
          - ä¸‹è½½ `.dmg` æ–‡ä»¶
          - åŒå‡»å®‰è£…ï¼Œæ‹–åŠ¨åˆ°åº”ç”¨ç¨‹åºæ–‡ä»¶å¤¹
          - é¦–æ¬¡è¿è¡Œéœ€è¦å³é”®ç‚¹å‡»"æ‰“å¼€"ï¼ˆç³»ç»Ÿå®‰å…¨è®¾ç½®ï¼‰
          
          **ç³»ç»Ÿè¦æ±‚**: macOS 10.13+
          
          ### Windows
          - ä¸‹è½½ `.zip` æ–‡ä»¶
          - è§£åŽ‹åˆ°ä»»æ„ä½ç½®
          - è¿è¡Œ `WeiboLifeboat.exe`
          
          **ç³»ç»Ÿè¦æ±‚**: Windows 10/11
          
          ---
          
          ## âœ¨ ä¸»è¦ç‰¹æ€§
          
          - âœ… **å…¨é‡å¤‡ä»½** - å¯¼å‡ºæ‰€æœ‰åŽ†å²å¾®åšï¼ˆæ–‡æœ¬ã€å›¾ç‰‡ã€è§†é¢‘ï¼‰
          - âœ… **æ–­ç‚¹ç»­ä¼ ** - æ”¯æŒä¸­æ–­åŽç»§ç»­ï¼Œä¸é‡å¤ä¸‹è½½
          - âœ… **ç²¾ç¾Žç•Œé¢** - macOS åŽŸç”Ÿ GUIï¼Œç®€æ´ä¼˜é›…
          - âœ… **åŽŸç”Ÿ WebView** - ä½¿ç”¨ç³»ç»Ÿæµè§ˆå™¨èŽ·å– Cookieï¼Œä½“ç§¯ä¼˜åŒ– 80%+
          - âœ… **ç¦»çº¿æµè§ˆ** - ç”Ÿæˆ Apple é£Žæ ¼çš„ HTML é¡µé¢
          
          ## ðŸŽ¯ ä½“ç§¯ä¼˜åŒ–
          
          æœ¬ç‰ˆæœ¬ä½¿ç”¨ç³»ç»ŸåŽŸç”Ÿ WebView æ›¿ä»£ QtWebEngineï¼š
          - macOSï¼šPyObjC + WKWebView
          - Windowsï¼šQAxWidget + Edge/IE
          - ä½“ç§¯ä»Ž 1.1GB â†’ ~200MBï¼ˆå‡å°‘ 82%ï¼‰
          
          ## ðŸ“ ä½¿ç”¨è¯´æ˜Ž
          
          1. **èŽ·å– Cookie**ï¼šç‚¹å‡»"æ›´æ–° Cookie"æŒ‰é’®ï¼Œåœ¨å¼¹å‡ºçš„æµè§ˆå™¨ä¸­ç™»å½•å¾®åš
          2. **å¼€å§‹å¤‡ä»½**ï¼šè¿”å›žä¸»ç•Œé¢ï¼Œç‚¹å‡»"å¼€å§‹é€ƒç”Ÿ"
          3. **æŸ¥çœ‹ç»“æžœ**ï¼šå¤‡ä»½å®ŒæˆåŽï¼Œåœ¨ `output/` ç›®å½•æŸ¥çœ‹ HTML æ–‡ä»¶
          
          ## ðŸ› é—®é¢˜åé¦ˆ
          
          å¦‚æœ‰é—®é¢˜ï¼Œè¯·åœ¨ [Issues](https://github.com/${{ github.repository }}/issues) ä¸­åé¦ˆã€‚
          
          ---
          
          **æ—¥å¿—ä½ç½®**ï¼š
          - macOS: `~/Library/Logs/WeiboLifeboat/app.log`
          - Windows: `%USERPROFILE%\AppData\Local\WeiboLifeboat\Logs\app.log`
          EOF
          
          # è¾“å‡ºåˆ°æ–‡ä»¶
          cat release_notes.md
      
      - name: åˆ›å»º Release
        uses: softprops/action-gh-release@v1
        with:
          name: å¾®åšé€ƒç”Ÿèˆ± ${{ github.ref_name }}
          body_path: release_notes.md
          files: |
            artifacts/*.dmg
            artifacts/*.zip
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

